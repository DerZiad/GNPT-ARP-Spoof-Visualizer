FROM maven:3.9.6-eclipse-temurin-21

# Install dependencies, including sudo
RUN apt-get update && apt-get install -y \
    unzip \
    wget \
    curl \
    xvfb \
    nmap \
    dsniff \
    git \
    sudo \
    libgtk-3-0 \
    libx11-xcb1 \
    libxtst6 \
    libxrender1 \
    libxi6 \
    libdbus-1-3 \
    libgl1 \
    && rm -rf /var/lib/apt/lists/*

# Create a user and give it passwordless sudo
RUN useradd -m docker && echo "docker ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to that user (to simulate a dev environment where sudo is needed)
USER docker

WORKDIR /app

COPY src .
COPY pom.xml .

RUN ls -a

# No change needed in base image (already root)

# Add at the bottom (or modify the existing RUN command):
RUN xvfb-run --auto-servernum --server-args="-screen 0 1024x768x16" \
    bash -c "mvn clean verify -DskipUnitTests=false"

